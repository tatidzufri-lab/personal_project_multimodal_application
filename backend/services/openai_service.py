"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ProxyAPI (OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API)
https://proxyapi.ru/docs/openai-text-generation
"""
import base64
import json
import re
import time
import logging
from typing import Optional

from openai import OpenAI

from backend.config import settings
from backend.models.schemas import CompetitorAnalysis, ImageAnalysis

# –õ–æ–≥–≥–µ—Ä –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
logger = logging.getLogger("competitor_monitor.openai")


class OpenAIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ ProxyAPI"""
    
    def __init__(self):
        logger.info("=" * 50)
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI —Å–µ—Ä–≤–∏—Å–∞")
        logger.info(f"  Base URL: {settings.proxy_api_base_url}")
        logger.info(f"  –ú–æ–¥–µ–ª—å —Ç–µ–∫—Å—Ç–∞: {settings.openai_model}")
        logger.info(f"  –ú–æ–¥–µ–ª—å vision: {settings.openai_vision_model}")
        logger.info(f"  API –∫–ª—é—á: {'*' * 10}...{settings.proxy_api_key[-4:] if settings.proxy_api_key else '–ù–ï –ó–ê–î–ê–ù'}")
        
        # ProxyAPI - OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API –¥–ª—è –†–æ—Å—Å–∏–∏
        self.client = OpenAI(
            api_key=settings.proxy_api_key,
            base_url=settings.proxy_api_base_url
        )
        self.model = settings.openai_model
        self.vision_model = settings.openai_vision_model
        
        logger.info("OpenAI —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ ‚úì")
        logger.info("=" * 50)
    
    def _parse_json_response(self, content: str) -> dict:
        """–ò–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏"""
        logger.debug(f"–ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞, –¥–ª–∏–Ω–∞: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –≤ markdown –±–ª–æ–∫–µ
        json_match = re.search(r'```(?:json)?\s*([\s\S]*?)\s*```', content)
        if json_match:
            content = json_match.group(1)
            logger.debug("JSON –Ω–∞–π–¥–µ–Ω –≤ markdown –±–ª–æ–∫–µ")
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç
        json_match = re.search(r'\{[\s\S]*\}', content)
        if json_match:
            content = json_match.group(0)
            logger.debug("JSON –æ–±—ä–µ–∫—Ç –∏–∑–≤–ª–µ—á—ë–Ω")
        
        try:
            result = json.loads(content)
            logger.debug(f"JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω, –∫–ª—é—á–µ–π: {len(result)}")
            return result
        except json.JSONDecodeError as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            logger.debug(f"–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç: {content[:200]}...")
            return {}
    
    async def analyze_text(self, text: str) -> CompetitorAnalysis:
        """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞"""
        logger.info("=" * 50)
        logger.info("üìù –ê–ù–ê–õ–ò–ó –¢–ï–ö–°–¢–ê –ö–û–ù–ö–£–†–ï–ù–¢–ê")
        logger.info(f"  –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        logger.info(f"  –ü—Ä–µ–≤—å—é: {text[:100]}...")
        logger.info(f"  –ú–æ–¥–µ–ª—å: {self.model}")
        
        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É –≤ —Å—Ñ–µ—Ä–µ —Ä–µ—Ç—Ä–∏—Ç–æ–≤ –≤ –≥–æ—Ä–∞—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ (—Ç–µ–∫—Å—Ç/–æ–ø–∏—Å–∞–Ω–∏–µ/–ª–µ–Ω–¥–∏–Ω–≥/–ø–æ—Å—Ç) –∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞, –±–µ–∑ –≤—ã–¥—É–º—ã–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ¬´–≤–µ—Ä–æ—è—Ç–Ω–æ¬ª, ¬´–ø–æ—Ö–æ–∂–µ¬ª, ¬´–Ω–µ —É–∫–∞–∑–∞–Ω–æ¬ª.


–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "strengths": ["—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1", "—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 2", ...],
    "weaknesses": ["—Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1", "—Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 2", ...],
    "unique_offers": ["—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1", "—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2", ...],
    "recommendations": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2", ...],
    "design_score": 0,
    "animation_potential": {
        "score": 0,
        "ideas": ["–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 1", "–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 2", ...],
        "notes": "–ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è: –≥–¥–µ –∏ –∑–∞—á–µ–º –∞–Ω–∏–º–∞—Ü–∏—è —É–º–µ—Å—Ç–Ω–∞ (–ª–µ–Ω–¥–∏–Ω–≥/—Å–æ—Ü—Å–µ—Ç–∏), —á—Ç–æ –æ–Ω–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç (–¥–æ–≤–µ—Ä–∏–µ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É/–∫–æ–Ω–≤–µ—Ä—Å–∏—é), –∏ –∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏–∑–±–µ–≥–∞—Ç—å"
    },
    "summary": "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∞–Ω–∞–ª–∏–∑–∞"
}


–ü—Ä–∞–≤–∏–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
- –ö–∞–∂–¥—ã–π –º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3-5 –ø—É–Ω–∫—Ç–æ–≤
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –ø—Ä–∞–∫—Ç–∏—á–µ–Ω –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö
- design_score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –æ—Ü–µ–Ω–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è (—á–∏—Å—Ç–æ—Ç–∞, —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ, —Ü–µ–ª—å–Ω–æ—Å—Ç—å –∞–π–¥–µ–Ω—Ç–∏–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ –≥–æ—Ä–Ω–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞)
- animation_potential.score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∞–Ω–∏–º–∞—Ü–∏–∏/–º–æ—É—à–µ–Ω–∞ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ –Ω–∏—à–µ –≥–æ—Ä–Ω–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞
- animation_potential.ideas: 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–¥–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–¥ ¬´—Ä–µ—Ç—Ä–∏—Ç –≤ –≥–æ—Ä–∞—Ö¬ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º—è–≥–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã, –ø–∞—Ä–∞–ª–ª–∞–∫—Å –≥–æ—Ä, ¬´–¥—ã—Ö–∞–Ω–∏–µ¬ª UI, –∞–Ω–∏–º–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞/–¥–Ω—è, micro-interactions –≤ —Ñ–æ—Ä–º–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ä–æ—Ç–∫–∏–µ –ª—É–ø—ã —Ç—É–º–∞–Ω–∞/–æ–±–ª–∞–∫–æ–≤)
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –±–µ–∑ Markdown."""


        start_time = time.time()
        logger.info("  –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API...")
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞:\n\n{text}"}
                ],
                temperature=0.7,
                max_tokens=2000
            )
            
            elapsed = time.time() - start_time
            logger.info(f"  ‚úì –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ {elapsed:.2f} —Å–µ–∫")
            
            content = response.choices[0].message.content
            logger.info(f"  –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            logger.debug(f"  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {response.usage.total_tokens if response.usage else 'N/A'}")
            
            data = self._parse_json_response(content)
            
            result = CompetitorAnalysis(
                strengths=data.get("strengths", []),
                weaknesses=data.get("weaknesses", []),
                unique_offers=data.get("unique_offers", []),
                recommendations=data.get("recommendations", []),
                summary=data.get("summary", "")
            )
            
            logger.info(f"  –†–µ–∑—É–ª—å—Ç–∞—Ç: {len(result.strengths)} —Å–∏–ª—å–Ω—ã—Ö, {len(result.weaknesses)} —Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω")
            logger.info("=" * 50)
            
            return result
            
        except Exception as e:
            elapsed = time.time() - start_time
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ API –∑–∞ {elapsed:.2f} —Å–µ–∫: {e}")
            logger.error("=" * 50)
            raise
    
    async def analyze_image(self, image_base64: str, mime_type: str = "image/jpeg") -> ImageAnalysis:
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±–∞–Ω–Ω–µ—Ä, —Å–∞–π—Ç, —É–ø–∞–∫–æ–≤–∫–∞)"""
        logger.info("=" * 50)
        logger.info("üñºÔ∏è –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø")
        logger.info(f"  –†–∞–∑–º–µ—Ä base64: {len(image_base64)} —Å–∏–º–≤–æ–ª–æ–≤")
        logger.info(f"  MIME —Ç–∏–ø: {mime_type}")
        logger.info(f"  –ú–æ–¥–µ–ª—å: {self.vision_model}")
        
        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ –¥–∏–∑–∞–π–Ω—É –≤ —Å—Ñ–µ—Ä–µ —Ä–µ—Ç—Ä–∏—Ç–æ–≤ –≤ –≥–æ—Ä–∞—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ (–±–∞–Ω–Ω–µ—Ä, —Å–∞–π—Ç, —É–ø–∞–∫–æ–≤–∫–∞, –∫—Ä–µ–∞—Ç–∏–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –∏ —Ç.–¥.) –∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –¥–µ—Ç–∞–ª–µ–π –Ω–µ –≤–∏–¥–Ω–æ –∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∑–∫–æ–µ, –æ—Ç–º–µ—á–∞–π —ç—Ç–æ —è–≤–Ω–æ –∏ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π ¬´–Ω–µ –≤–∏–¥–Ω–æ¬ª, ¬´–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è¬ª, ¬´–ø–æ—Ö–æ–∂–µ¬ª).


–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "description": "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ",
    "marketing_insights": ["–∏–Ω—Å–∞–π—Ç 1", "–∏–Ω—Å–∞–π—Ç 2", ...],
    "visual_style_score": 0,
    "visual_style_analysis": "–ê–Ω–∞–ª–∏–∑ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
    "design_score": 0,
    "animation_potential": {
        "score": 0,
        "ideas": ["–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 1", "–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 2", ...],
        "notes": "–ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è: –≥–¥–µ –∏ –∑–∞—á–µ–º –∞–Ω–∏–º–∞—Ü–∏—è —É–º–µ—Å—Ç–Ω–∞ (–ª–µ–Ω–¥–∏–Ω–≥/—Å–æ—Ü—Å–µ—Ç–∏), —á—Ç–æ –æ–Ω–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç (–∞—Ç–º–æ—Å—Ñ–µ—Ä—É/–¥–æ–≤–µ—Ä–∏–µ/–∫–æ–Ω–≤–µ—Ä—Å–∏—é), –∏ –∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏–∑–±–µ–≥–∞—Ç—å"
    },
    "recommendations": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2", ...]
}


–ü—Ä–∞–≤–∏–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
- visual_style_score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –æ—Ü–µ–Ω–∫–∞ –≤–∏–∑—É–∞–ª–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º (—Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ, UX/UI —ç–ª–µ–º–µ–Ω—Ç—ã)
- design_score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –æ—Ü–µ–Ω–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∏–º–µ–Ω–Ω–æ –ø–æ–¥ –Ω–∏—à—É ¬´—Ä–µ—Ç—Ä–∏—Ç –≤ –≥–æ—Ä–∞—Ö¬ª (–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ø—Ä–∏—Ä–æ–¥—ã, –æ—â—É—â–µ–Ω–∏–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, —Ü–µ–ª—å–Ω–æ—Å—Ç—å –∞–π–¥–µ–Ω—Ç–∏–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏)
- animation_potential.score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏/–º–æ—É—à–µ–Ω–∞ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
- –ö–∞–∂–¥—ã–π –º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3-5 –ø—É–Ω–∫—Ç–æ–≤
- marketing_insights: 3-5 –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (—á—Ç–æ –ø—Ä–æ–¥–∞—é—Ç, –∫–æ–º—É, —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã: –ø—Ä–∏—Ä–æ–¥–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –≤–µ–¥—É—â–∏—Ö, –∫–æ–º—å—é–Ω–∏—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø—Ä–æ–≥—Ä–∞–º–º–∞, —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä)
- animation_potential.ideas: 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–¥–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–¥ ¬´—Ä–µ—Ç—Ä–∏—Ç –≤ –≥–æ—Ä–∞—Ö¬ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º—è–≥–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã, –ø–∞—Ä–∞–ª–ª–∞–∫—Å –≥–æ—Ä/–æ–±–ª–∞–∫–æ–≤, ¬´–¥—ã—Ö–∞–Ω–∏–µ¬ª UI, –∞–Ω–∏–º–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞/–¥–Ω—è, micro-interactions –≤ —Ñ–æ—Ä–º–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ä–æ—Ç–∫–∏–µ –ª—É–ø—ã —Ç—É–º–∞–Ω–∞/—Å–Ω–µ–≥–∞/–∫–æ—Å—Ç—Ä–∞)
- recommendations: 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —è—Å–Ω–æ—Å—Ç–∏ –æ—Ñ—Ñ–µ—Ä–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (CTA, –∏–µ—Ä–∞—Ä—Ö–∏—è, –¥–æ–≤–µ—Ä–∏–µ, —Ü–µ–Ω—ã/–¥–∞—Ç—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤, —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å)
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –±–µ–∑ Markdown."""


        start_time = time.time()
        logger.info("  –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Vision API...")
        
        try:
            response = self.client.chat.completions.create(
                model=self.vision_model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ –¥–∏–∑–∞–π–Ω–∞:"
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:{mime_type};base64,{image_base64}"
                                }
                            }
                        ]
                    }
                ],
                temperature=0.7,
                max_tokens=2000
            )
            
            elapsed = time.time() - start_time
            logger.info(f"  ‚úì –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ {elapsed:.2f} —Å–µ–∫")
            
            content = response.choices[0].message.content
            logger.info(f"  –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            data = self._parse_json_response(content)
            
            result = ImageAnalysis(
                description=data.get("description", ""),
                marketing_insights=data.get("marketing_insights", []),
                visual_style_score=data.get("visual_style_score", 5),
                visual_style_analysis=data.get("visual_style_analysis", ""),
                recommendations=data.get("recommendations", [])
            )
            
            logger.info(f"  –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—Ü–µ–Ω–∫–∞ —Å—Ç–∏–ª—è {result.visual_style_score}/10")
            logger.info(f"  –ò–Ω—Å–∞–π—Ç–æ–≤: {len(result.marketing_insights)}, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {len(result.recommendations)}")
            logger.info("=" * 50)
            
            return result
            
        except Exception as e:
            elapsed = time.time() - start_time
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ Vision API –∑–∞ {elapsed:.2f} —Å–µ–∫: {e}")
            logger.error("=" * 50)
            raise
    
    async def analyze_parsed_content(
        self, 
        title: Optional[str], 
        h1: Optional[str], 
        paragraph: Optional[str]
    ) -> CompetitorAnalysis:
        """–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–∞–π—Ç–∞"""
        logger.info("üìÑ –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞")
        logger.info(f"  Title: {title[:50] if title else 'N/A'}...")
        logger.info(f"  H1: {h1[:50] if h1 else 'N/A'}...")
        logger.info(f"  –ê–±–∑–∞—Ü: {paragraph[:50] if paragraph else 'N/A'}...")
        
        content_parts = []
        if title:
            content_parts.append(f"–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (title): {title}")
        if h1:
            content_parts.append(f"–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (H1): {h1}")
        if paragraph:
            content_parts.append(f"–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü: {paragraph}")
        
        combined_text = "\n\n".join(content_parts)
        
        if not combined_text.strip():
            logger.warning("  ‚ö† –ö–æ–Ω—Ç–µ–Ω—Ç –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑")
            return CompetitorAnalysis(
                summary="–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
            )
        
        return await self.analyze_text(combined_text)
    
    async def analyze_website_screenshot(
        self,
        screenshot_base64: str,
        url: str,
        title: Optional[str] = None,
        h1: Optional[str] = None,
        first_paragraph: Optional[str] = None
    ) -> CompetitorAnalysis:
        """–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∞–π—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –ø–æ —Å–∫—Ä–∏–Ω—à–æ—Ç—É"""
        logger.info("=" * 50)
        logger.info("üåê –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –°–ê–ô–¢–ê")
        logger.info(f"  URL: {url}")
        logger.info(f"  Title: {title[:50] if title else 'N/A'}...")
        logger.info(f"  H1: {h1[:50] if h1 else 'N/A'}...")
        logger.info(f"  –†–∞–∑–º–µ—Ä —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: {len(screenshot_base64)} —Å–∏–º–≤–æ–ª–æ–≤ base64")
        logger.info(f"  –ú–æ–¥–µ–ª—å: {self.vision_model}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        context_parts = [f"URL —Å–∞–π—Ç–∞: {url}"]
        if title:
            context_parts.append(f"Title —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {title}")
        if h1:
            context_parts.append(f"–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (H1): {h1}")
        if first_paragraph:
            context_parts.append(f"–¢–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {first_paragraph[:300]}")
        
        context = "\n".join(context_parts)
        logger.debug(f"  –ö–æ–Ω—Ç–µ–∫—Å—Ç:\n{context}")
        
        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ UX/UI –¥–∏–∑–∞–π–Ω—É –≤ —Å—Ñ–µ—Ä–µ —Ä–µ—Ç—Ä–∏—Ç–æ–≤ –≤ –≥–æ—Ä–∞—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–∞–π—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ —á–∞—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –Ω–µ –≤–∏–¥–Ω–∞/–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è, –æ—Ç–º–µ—á–∞–π —ç—Ç–æ —è–≤–Ω–æ –∏ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π ¬´–Ω–µ –≤–∏–¥–Ω–æ¬ª, ¬´–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è¬ª, ¬´–≤–µ—Ä–æ—è—Ç–Ω–æ¬ª).


–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "strengths": ["—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1", "—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 2", ...],
    "weaknesses": ["—Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1", "—Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 2", ...],
    "unique_offers": ["—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/—Ñ–∏—á–∞ 1", "—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/—Ñ–∏—á–∞ 2", ...],
    "recommendations": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2", ...],
    "design_score": 0,
    "animation_potential": {
        "score": 0,
        "ideas": ["–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 1", "–∏–¥–µ—è –∞–Ω–∏–º–∞—Ü–∏–∏ 2", ...],
        "notes": "–ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è: –≥–¥–µ –∏ –∑–∞—á–µ–º –∞–Ω–∏–º–∞—Ü–∏—è —É–º–µ—Å—Ç–Ω–∞ (hero/–±–ª–æ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã/—Ñ–æ—Ä–º–∞ –±—Ä–æ–Ω–∏/—Å—Ç–æ—Ä–∏—Å), —á—Ç–æ –æ–Ω–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç (–∞—Ç–º–æ—Å—Ñ–µ—Ä—É –≥–æ—Ä–Ω–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞/–¥–æ–≤–µ—Ä–∏–µ/–∫–æ–Ω–≤–µ—Ä—Å–∏—é), –∏ –∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏–∑–±–µ–≥–∞—Ç—å"
    },
    "summary": "–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ–∑—é–º–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞"
}


–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
- –î–∏–∑–∞–π–Ω –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (—Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç—ã, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ, —Ü–µ–ª—å–Ω–æ—Å—Ç—å –∞–π–¥–µ–Ω—Ç–∏–∫–∏)
- UX/UI: –Ω–∞–≤–∏–≥–∞—Ü–∏—è, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∑–∞–º–µ—Ç–Ω–æ—Å—Ç—å CTA, —Ñ–æ—Ä–º—ã/–ø–æ–ª—è, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
- –ö–æ–Ω—Ç–µ–Ω—Ç: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ç–µ–∫—Å—Ç—ã, —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é, —è—Å–Ω–æ—Å—Ç—å –æ—Ñ—Ñ–µ—Ä–∞
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–£–¢–ü) –∏ —Ñ–∏—á–∏ (–ø—Ä–æ–≥—Ä–∞–º–º–∞, –≤–µ–¥—É—â–∏–µ, –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∫–æ–º—å—é–Ω–∏—Ç–∏)
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –∫–æ–º—É –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ, —É—Ä–æ–≤–µ–Ω—å ¬´–ø—Ä–µ–º–∏—É–º/–¥–æ—Å—Ç—É–ø–Ω–æ¬ª, –æ–∂–∏–¥–∞–Ω–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –¥–∏–∑–∞–π–Ω–∞ (–∞–¥–∞–ø—Ç–∏–≤, –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –ª–æ–≥–∏–∫–∞ –ª–µ–Ω–¥–∏–Ω–≥–∞)


–ü—Ä–∞–≤–∏–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
- –ö–∞–∂–¥—ã–π –º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 4-6 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –ø—Ä–∞–∫—Ç–∏—á–µ–Ω
- –î–∞–≤–∞–π actionable —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å, –≥–¥–µ –∏–º–µ–Ω–Ω–æ, –∏ –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
- design_score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –æ—Ü–µ–Ω–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –ø–æ–¥ –Ω–∏—à—É ¬´—Ä–µ—Ç—Ä–∏—Ç –≤ –≥–æ—Ä–∞—Ö¬ª (–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ø—Ä–∏—Ä–æ–¥—ã –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è, –æ—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å, –∫–∞—á–µ—Å—Ç–≤–æ –≤–∏–∑—É–∞–ª–∞, —Ü–µ–ª—å–Ω–æ—Å—Ç—å)
- animation_potential.score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∞–Ω–∏–º–∞—Ü–∏–∏/–º–æ—É—à–µ–Ω–∞ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
- animation_potential.ideas: 4-6 –∏–¥–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≥–æ—Ä–Ω–æ–º—É —Ä–µ—Ç—Ä–∏—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º—è–≥–∫–∏–π –ø–∞—Ä–∞–ª–ª–∞–∫—Å –≥–æ—Ä/–æ–±–ª–∞–∫–æ–≤ –≤ hero, –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ —Å–∫—Ä–æ–ª–ª—É, –∞–Ω–∏–º–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞/–¥–Ω—è —Ä–µ—Ç—Ä–∏—Ç–∞, micro-interactions –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–∞—Ç –∏ —Ñ–æ—Ä–º–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ª—É–ø—ã —Ç—É–º–∞–Ω–∞/–∫–æ—Å—Ç—Ä–∞/—Å–Ω–µ–≥–∞, ¬´–ø—Ä–æ–≥—Ä–µ—Å—Å¬ª –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏)
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –±–µ–∑ Markdown."""


        start_time = time.time()
        logger.info("  –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –≤ Vision API...")
        
        try:
            response = self.client.chat.completions.create(
                model=self.vision_model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": f"–ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞:\n\n{context}"
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{screenshot_base64}"
                                }
                            }
                        ]
                    }
                ],
                temperature=0.7,
                max_tokens=3000
            )
            
            elapsed = time.time() - start_time
            logger.info(f"  ‚úì –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ {elapsed:.2f} —Å–µ–∫")
            
            content = response.choices[0].message.content
            logger.info(f"  –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            data = self._parse_json_response(content)
            
            result = CompetitorAnalysis(
                strengths=data.get("strengths", []),
                weaknesses=data.get("weaknesses", []),
                unique_offers=data.get("unique_offers", []),
                recommendations=data.get("recommendations", []),
                summary=data.get("summary", "")
            )
            
            logger.info(f"  –†–µ–∑—É–ª—å—Ç–∞—Ç:")
            logger.info(f"    - –°–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω: {len(result.strengths)}")
            logger.info(f"    - –°–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω: {len(result.weaknesses)}")
            logger.info(f"    - –£–¢–ü: {len(result.unique_offers)}")
            logger.info(f"    - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {len(result.recommendations)}")
            logger.info(f"  –†–µ–∑—é–º–µ: {result.summary[:100]}...")
            logger.info("=" * 50)
            
            return result
            
        except Exception as e:
            elapsed = time.time() - start_time
            logger.error(f"  ‚úó –û—à–∏–±–∫–∞ Vision API –∑–∞ {elapsed:.2f} —Å–µ–∫: {e}")
            logger.error("=" * 50)
            raise


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
logger.info("–°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ OpenAI —Å–µ—Ä–≤–∏—Å–∞...")
openai_service = OpenAIService()
